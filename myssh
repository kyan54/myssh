#!/usr/bin/env bash
# =============================================================================
# MySsh - WSL SSHæœåŠ¡å™¨å¿«é€Ÿè¿æ¥å·¥å…·
# åŠŸèƒ½ï¼šæ¨¡ç³Šæœç´¢æœåŠ¡å™¨åˆ—è¡¨ï¼Œæ”¯æŒ sshpass è¿æ¥å’Œ WinSCP æ–‡ä»¶ç®¡ç†
# =============================================================================

set -o pipefail

# é…ç½®
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVERS_FILE="${MYSSH_SERVERS_FILE:-$SCRIPT_DIR/servers.txt}"
WINSCP_EXE="${MYSSH_WINSCP_PATH:-/mnt/c/Users/THINKBOOK/AppData/Local/Programs/WinSCP/WinSCP.exe}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# åˆ—å®½é…ç½®ï¼ˆç”¨äºè¡¨æ ¼å¯¹é½ï¼‰
LABEL_W=20
HOST_W=17
PORT_W=7
USER_W=17

# =============================================================================
# å·¥å…·å‡½æ•°
# =============================================================================

print_error() {
    echo -e "${RED}âœ— é”™è¯¯: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_info() {
    echo -e "${CYAN}âœ $1${NC}"
}

print_warn() {
    echo -e "${YELLOW}âš  $1${NC}"
}

# è®¡ç®—å­—ç¬¦ä¸²æ˜¾ç¤ºå®½åº¦ï¼ˆä¸­æ–‡å 2ï¼Œè‹±æ–‡å 1ï¼‰
display_width() {
    local str="$1"
    local width=0
    local char
    for ((i=0; i<${#str}; i++)); do
        char="${str:i:1}"
        # æ£€æŸ¥æ˜¯å¦ä¸ºå¤šå­—èŠ‚å­—ç¬¦ï¼ˆä¸­æ–‡ç­‰ï¼‰
        if [[ $(printf '%s' "$char" | wc -c) -gt 1 ]]; then
            ((width+=2))
        else
            ((width+=1))
        fi
    done
    echo $width
}

# åˆå§‹åŒ–åˆ—å®½ï¼ˆæ ¹æ®ç»ˆç«¯å®½åº¦åŠ¨æ€è°ƒæ•´æ ‡ç­¾åˆ—ï¼Œé¿å…è¢«æˆªæ–­è¿‡å¤šï¼‰
init_column_widths() {
    local term_cols
    term_cols=$(tput cols 2>/dev/null || echo 120)
    local content_cols=$((term_cols - 4)) # é¢„ç•™æŒ‡ç¤ºç¬¦å’Œè¾¹è·
    local sep_w=9  # " â”‚ " * 3
    local min_label=16
    local max_label=60

    local label_w=$((content_cols - HOST_W - PORT_W - USER_W - sep_w))
    if ((label_w < min_label)); then
        label_w=$min_label
    elif ((label_w > max_label)); then
        label_w=$max_label
    fi
    LABEL_W=$label_w
}

# é‡å¤å­—ç¬¦
repeat_char() {
    local count="$1"
    local char="$2"
    local out=""
    for ((i=0; i<count; i++)); do
        out+="$char"
    done
    printf '%s' "$out"
}

# ç”Ÿæˆ fzf è¡¨å¤´
build_fzf_header() {
    local title="ğŸ” MySsh - æœåŠ¡å™¨å¿«é€Ÿè¿æ¥ (è¾“å…¥å…³é”®å­—æœç´¢, Enterç¡®è®¤, Escé€€å‡º)"
    local col_header
    col_header=$(printf "%s â”‚ %s â”‚ %s â”‚ %s" \
        "$(pad_string "æ ‡ç­¾" "$LABEL_W")" \
        "$(pad_string "æœåŠ¡å™¨IP" "$HOST_W")" \
        "$(pad_string "ç«¯å£" "$PORT_W")" \
        "$(pad_string "ç”¨æˆ·å" "$USER_W")")
    local sep_line
    sep_line=$(printf "%sâ”€â”¼â”€%sâ”€â”¼â”€%sâ”€â”¼â”€%s" \
        "$(repeat_char "$LABEL_W" "â”€")" \
        "$(repeat_char "$HOST_W" "â”€")" \
        "$(repeat_char "$PORT_W" "â”€")" \
        "$(repeat_char "$USER_W" "â”€")")

    printf "%s\n%s\n%s" "$title" "$col_header" "$sep_line"
}

# æˆªæ–­å­—ç¬¦ä¸²åˆ°æŒ‡å®šæ˜¾ç¤ºå®½åº¦
truncate_string() {
    local str="$1"
    local max_width="$2"
    local width=0
    local char char_w out=""

    for ((i=0; i<${#str}; i++)); do
        char="${str:i:1}"
        if [[ $(printf '%s' "$char" | wc -c) -gt 1 ]]; then
            char_w=2
        else
            char_w=1
        fi
        if (( width + char_w > max_width )); then
            break
        fi
        width=$((width + char_w))
        out+="$char"
    done
    printf '%s' "$out"
}

# æŒ‰æŒ‡å®šå®½åº¦å¡«å……å­—ç¬¦ä¸²
pad_string() {
    local str="$1"
    local target_width="$2"
    local truncated
    truncated=$(truncate_string "$str" "$target_width")
    local current_width
    current_width=$(display_width "$truncated")
    local padding=$((target_width - current_width))
    printf '%s' "$truncated"
    if [[ $padding -gt 0 ]]; then
        printf '%*s' "$padding" ''
    fi
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local missing=()
    
    if ! command -v sshpass &>/dev/null; then
        missing+=("sshpass")
    fi
    
    if ! command -v fzf &>/dev/null; then
        missing+=("fzf")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        print_error "ç¼ºå°‘å¿…éœ€çš„ä¾èµ–: ${missing[*]}"
        echo "è¯·å®‰è£…: sudo apt install ${missing[*]}"
        exit 1
    fi
    
    # æ£€æŸ¥ WinSCPï¼ˆä»…è­¦å‘Šï¼Œä¸é˜»æ­¢è¿è¡Œï¼‰
    if [[ ! -f "$WINSCP_EXE" ]]; then
        print_warn "WinSCP æœªæ‰¾åˆ°: $WINSCP_EXE"
        echo "      WinSCP åŠŸèƒ½ (-w) å°†ä¸å¯ç”¨ï¼Œè¯·å®‰è£… WinSCP æˆ–è®¾ç½® MYSSH_WINSCP_PATH"
    fi
}

# æ£€æŸ¥æœåŠ¡å™¨é…ç½®æ–‡ä»¶
check_servers_file() {
    if [[ ! -f "$SERVERS_FILE" ]]; then
        print_error "æœåŠ¡å™¨é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $SERVERS_FILE"
        echo ""
        echo "è¯·åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆæ¯è¡Œä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½¿ç”¨ Tab åˆ†éš”ï¼‰:"
        echo -e "${CYAN}æ ‡ç­¾å\tæœåŠ¡å™¨IP\tç«¯å£\tè´¦å·\tå¯†ç ${NC}"
        echo ""
        echo "ç¤ºä¾‹:"
        echo -e "${CYAN}ç”Ÿäº§æœåŠ¡å™¨\t192.168.1.100\t22\troot\tpassword123${NC}"
        exit 1
    fi
}

# =============================================================================
# æ ¸å¿ƒåŠŸèƒ½
# =============================================================================

# åŠ è½½æœåŠ¡å™¨åˆ—è¡¨
# æ”¯æŒæ ¼å¼ï¼š
#   1. çº¯Tabåˆ†éš”: æ ‡ç­¾å\tæœåŠ¡å™¨IP\tç«¯å£\tè´¦å·\tå¯†ç 
#   2. æ··åˆåˆ†éš”: æ ‡ç­¾å\tæœåŠ¡å™¨IP ç«¯å£ è´¦å· å¯†ç 
#   3. çº¯ç©ºæ ¼åˆ†éš”: æ ‡ç­¾å æœåŠ¡å™¨IP ç«¯å£ è´¦å· å¯†ç 
load_servers() {
    local line label host port user pass
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
        
        # å°†Tabæ›¿æ¢ä¸ºç©ºæ ¼ï¼Œç»Ÿä¸€ç”¨ç©ºæ ¼åˆ†éš”
        line="${line//$'\t'/ }"
        
        # æŒ‰ç©ºæ ¼åˆ†éš”è¯»å–å„å­—æ®µ
        read -r label host port user pass <<< "$line"

        # è·³è¿‡æ ¼å¼ä¸å®Œæ•´çš„è¡Œ
        [[ -z "$label" || -z "$host" || -z "$port" || -z "$user" || -z "$pass" ]] && continue

        printf '%s|%s|%s|%s|%s\n' "$label" "$host" "$port" "$user" "$pass"
    done < "$SERVERS_FILE"
}

# æŒ‰æ˜¾ç¤ºå®½åº¦ï¼ˆå…¼å®¹ä¸­æ–‡åŒå®½å­—ç¬¦ï¼‰æ ¼å¼åŒ–æœåŠ¡å™¨è¡Œ
# è¾“å…¥: label|host|port|user|pass
# è¾“å‡º: index<TAB>æ ¼å¼åŒ–åçš„æ˜¾ç¤ºè¡Œ
format_servers_for_display() {
    local label_w="$1"
    local host_w="$2"
    local port_w="$3"
    local user_w="$4"

    if command -v python3 &>/dev/null; then
        python3 - "$label_w" "$host_w" "$port_w" "$user_w" 3<&0 << 'PY'
import sys
import unicodedata

label_w, host_w, port_w, user_w = map(int, sys.argv[1:5])

def char_width(ch: str) -> int:
    if unicodedata.combining(ch):
        return 0
    return 2 if unicodedata.east_asian_width(ch) in ("W", "F") else 1

def fit_text(text: str, width: int) -> str:
    out = []
    used = 0
    overflow = False
    for ch in text:
        w = char_width(ch)
        if used + w > width:
            overflow = True
            break
        out.append(ch)
        used += w

    if overflow and width >= 3:
        while out and used > width - 3:
            last = out.pop()
            used -= char_width(last)
        out.extend("...")
        used += 3

    return "".join(out) + (" " * max(0, width - used))

for idx, raw in enumerate(open(3, "r", encoding="utf-8", errors="replace"), start=1):
    line = raw.rstrip("\n")
    if not line:
        continue
    parts = line.split("|")
    if len(parts) < 4:
        continue

    label, host, port, user = parts[0], parts[1], parts[2], parts[3]
    row = (
        f"{fit_text(label, label_w)} â”‚ "
        f"{fit_text(host, host_w)} â”‚ "
        f"{fit_text(port, port_w)} â”‚ "
        f"{fit_text(user, user_w)}"
    )
    print(f"{idx}\t{row}")
PY
    else
        # æ—  python3 æ—¶å›é€€ï¼šæŒ‰å­—ç¬¦æ•°å¯¹é½ï¼ˆä¸­æ–‡å®½åº¦å¯èƒ½ç•¥æœ‰è¯¯å·®ï¼‰
        awk -F'|' -v label_w="$label_w" -v host_w="$host_w" -v port_w="$port_w" -v user_w="$user_w" '
            function trunc(s, w) {
                if (length(s) <= w) return s
                if (w <= 3) return substr(s, 1, w)
                return substr(s, 1, w - 3) "..."
            }
            {
                printf "%d\t%-*s â”‚ %-*s â”‚ %-*s â”‚ %-*s\n", NR, label_w, trunc($1, label_w), host_w, trunc($2, host_w), port_w, trunc($3, port_w), user_w, trunc($4, user_w)
            }
        '
    fi
}

# æ ¼å¼åŒ–æ˜¾ç¤ºæœåŠ¡å™¨åˆ—è¡¨
format_server_list() {
    local index=1
    while IFS='|' read -r label host port user pass; do
        printf "%-3s â”‚ %s â”‚ %s â”‚ %s â”‚ %s\n" \
            "$index" \
            "$(pad_string "$label" "$LABEL_W")" \
            "$(pad_string "$host" "$HOST_W")" \
            "$(pad_string "$port" "$PORT_W")" \
            "$(pad_string "$user" "$USER_W")"
        ((index++))
    done
}

# ä½¿ç”¨ fzf é€‰æ‹©æœåŠ¡å™¨
select_server_with_fzf() {
    init_column_widths
    local servers
    servers=$(load_servers)
    
    if [[ -z "$servers" ]]; then
        print_error "æœåŠ¡å™¨åˆ—è¡¨ä¸ºç©º"
        exit 1
    fi
    
    # æ„å»º fzf è¾“å…¥ï¼š
    #   1) æ˜¾ç¤ºåˆ—ï¼šå›ºå®šå®½åº¦ï¼Œä¿è¯å¯¹é½
    #   2) æœç´¢åˆ—ï¼šä¿ç•™åŸå§‹å­—æ®µï¼Œé¿å…å› æ˜¾ç¤ºæˆªæ–­å¯¼è‡´æœä¸åˆ°
    local formatted
    formatted=$(paste \
        <(printf '%s\n' "$servers" | format_servers_for_display "$LABEL_W" "$HOST_W" "$PORT_W" "$USER_W") \
        <(printf '%s\n' "$servers" | awk -F'|' '{printf "%s\t%s\t%s\t%s\n", $1, $2, $3, $4}')
    )
    
    # ä½¿ç”¨ fzf è¿›è¡Œæ¨¡ç³Šæœç´¢
    local header
    local header_cols
    header_cols=$(printf '%s\n' "æ ‡ç­¾|æœåŠ¡å™¨IP|ç«¯å£|ç”¨æˆ·å|-" | format_servers_for_display "$LABEL_W" "$HOST_W" "$PORT_W" "$USER_W" | cut -f2-)
    header=$(printf "ğŸ” MySsh - æœåŠ¡å™¨å¿«é€Ÿè¿æ¥ (è¾“å…¥å…³é”®å­—æœç´¢, Enterç¡®è®¤, Escé€€å‡º)\n%s" "$header_cols")
    
    local selected_line
    selected_line=$(printf '%s\n' "$formatted" | fzf \
        --header="$header" \
        --height=60% \
        --layout=reverse \
        --border=rounded \
        --prompt=" æœç´¢: " \
        --pointer="â–¶" \
        --marker="âœ“" \
        --color="header:italic:yellow,prompt:green,pointer:cyan,marker:magenta" \
        --preview-window=hidden \
        --bind="enter:accept" \
        --bind="esc:abort" \
        --delimiter=$'\t' \
        --with-nth=2 \
        --no-info)
    
    if [[ -z "$selected_line" ]]; then
        return 1
    fi
    
    # æ ¹æ®é€‰ä¸­çš„è¡Œç´¢å¼•æ‰¾å›å®Œæ•´æ•°æ®
    local line_index
    line_index=$(printf '%s' "$selected_line" | cut -f1)
    printf '%s\n' "$servers" | sed -n "${line_index}p"
}

# SSH è¿æ¥
connect_ssh() {
    local host="$1"
    local port="$2"
    local user="$3"
    local pass="$4"
    
    print_info "æ­£åœ¨è¿æ¥ ${user}@${host}:${port} ..."
    echo ""
    
    sshpass -p "$pass" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
        -p "$port" "${user}@${host}"
}

# æ‰“å¼€ WinSCP
open_winscp() {
    local host="$1"
    local port="$2"
    local user="$3"
    local pass="$4"
    local remote_path="${5:-/}"
    
    if [[ ! -f "$WINSCP_EXE" ]]; then
        print_error "WinSCP æœªæ‰¾åˆ°: $WINSCP_EXE"
        echo "è¯·å®‰è£… WinSCP æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ MYSSH_WINSCP_PATH"
        return 1
    fi
    
    # URL ç¼–ç å¯†ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦
    local encoded_pass
    encoded_pass=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$pass', safe=''))" 2>/dev/null || echo "$pass")
    
    local url="sftp://${user}:${encoded_pass}@${host}:${port}${remote_path}"
    
    print_info "æ­£åœ¨æ‰“å¼€ WinSCP è¿æ¥ ${host}..."
    "$WINSCP_EXE" "$url" >/dev/null 2>&1 &
    print_success "WinSCP å·²å¯åŠ¨"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    echo ""
    echo -e "${BOLD}MySsh - WSL SSHæœåŠ¡å™¨å¿«é€Ÿè¿æ¥å·¥å…·${NC}"
    echo ""
    echo -e "${CYAN}ç”¨æ³•:${NC}"
    echo "  myssh              äº¤äº’å¼é€‰æ‹©æœåŠ¡å™¨å¹¶ SSH è¿æ¥"
    echo "  myssh -w           äº¤äº’å¼é€‰æ‹©æœåŠ¡å™¨å¹¶ç”¨ WinSCP æ‰“å¼€"
    echo "  myssh -l           åˆ—å‡ºæ‰€æœ‰æœåŠ¡å™¨"
    echo "  myssh -e           ç¼–è¾‘æœåŠ¡å™¨é…ç½®æ–‡ä»¶"
    echo "  myssh -h           æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo ""
    echo -e "${CYAN}ç¯å¢ƒå˜é‡:${NC}"
    echo "  MYSSH_SERVERS_FILE  æœåŠ¡å™¨é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: $SCRIPT_DIR/servers.txt)"
    echo "  MYSSH_WINSCP_PATH   WinSCP å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„"
    echo ""
    echo -e "${CYAN}é…ç½®æ–‡ä»¶æ ¼å¼:${NC}"
    echo "  æ¯è¡Œä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½¿ç”¨ Tab åˆ†éš”:"
    echo -e "  ${YELLOW}æ ‡ç­¾å\tæœåŠ¡å™¨IP\tç«¯å£\tè´¦å·\tå¯†ç ${NC}"
    echo ""
    echo -e "${CYAN}ç¤ºä¾‹:${NC}"
    echo -e "  ${YELLOW}ç”Ÿäº§æœåŠ¡å™¨\t192.168.1.100\t22\troot\tmypassword${NC}"
    echo -e "  ${YELLOW}æµ‹è¯•ç¯å¢ƒ\t10.0.0.50\t2222\tadmin\ttest123${NC}"
    echo ""
}

# åˆ—å‡ºæœåŠ¡å™¨
list_servers() {
    check_servers_file
    
    echo ""
    echo -e "${BOLD}æœåŠ¡å™¨åˆ—è¡¨${NC} (${SERVERS_FILE})"
    local header_cols
    header_cols=$(printf '%s\n' "æ ‡ç­¾|æœåŠ¡å™¨IP|ç«¯å£|ç”¨æˆ·å|-" | format_servers_for_display 20 17 7 17 | cut -f2-)
    printf "${CYAN}%-3s â”‚ %s${NC}\n" "#" "$header_cols"
    printf '%s\n' "â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    while IFS=$'\t' read -r idx row; do
        [[ -z "$idx" ]] && continue
        printf "%-3s â”‚ %s\n" "$idx" "$row"
    done < <(load_servers | format_servers_for_display 20 17 7 17)
    echo ""
}

# ç¼–è¾‘é…ç½®æ–‡ä»¶
edit_servers() {
    local editor="${EDITOR:-nano}"
    
    # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ¨¡æ¿
    if [[ ! -f "$SERVERS_FILE" ]]; then
        mkdir -p "$(dirname "$SERVERS_FILE")"
        cat > "$SERVERS_FILE" << 'EOF'
# MySsh æœåŠ¡å™¨é…ç½®æ–‡ä»¶
# æ ¼å¼: æ ‡ç­¾å<TAB>æœåŠ¡å™¨IP<TAB>ç«¯å£<TAB>è´¦å·<TAB>å¯†ç 
# æ³¨æ„: ä½¿ç”¨ Tab é”®åˆ†éš”å„å­—æ®µï¼Œä»¥ # å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Š
#
# ç¤ºä¾‹:
#ç”Ÿäº§æœåŠ¡å™¨	192.168.1.100	22	root	password123
#æµ‹è¯•ç¯å¢ƒ	10.0.0.50	2222	admin	test456
EOF
        print_info "å·²åˆ›å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿: $SERVERS_FILE"
    fi
    
    "$editor" "$SERVERS_FILE"
}

# =============================================================================
# ä¸»ç¨‹åº
# =============================================================================

main() {
    local mode="ssh"  # é»˜è®¤æ¨¡å¼: ssh
    
    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -w|--winscp)
                mode="winscp"
                shift
                ;;
            -l|--list)
                list_servers
                exit 0
                ;;
            -e|--edit)
                edit_servers
                exit 0
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                print_error "æœªçŸ¥å‚æ•°: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    # æ£€æŸ¥ä¾èµ–å’Œé…ç½®
    check_dependencies
    check_servers_file
    
    # é€‰æ‹©æœåŠ¡å™¨
    local selected
    selected=$(select_server_with_fzf)
    
    if [[ -z "$selected" ]]; then
        print_info "å·²å–æ¶ˆ"
        exit 0
    fi
    
    # è§£æé€‰ä¸­çš„æœåŠ¡å™¨ä¿¡æ¯
    local label host port user pass
    IFS='|' read -r label host port user pass <<< "$selected"
    
    echo ""
    print_success "å·²é€‰æ‹©: $label ($host)"
    
    # æ‰§è¡Œæ“ä½œ
    case "$mode" in
        ssh)
            connect_ssh "$host" "$port" "$user" "$pass"
            ;;
        winscp)
            open_winscp "$host" "$port" "$user" "$pass"
            ;;
    esac
}

main "$@"
